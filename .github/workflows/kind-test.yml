name: "Create cluster using KinD"
on: [pull_request, push]

jobs:
  prereqs:
    runs-on: ubuntu-latest
    steps:
      - name: grab kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.32.0'
      - name: install kind locally
        run: |

          # Install kind...
          # For AMD64 / x86_64
          [ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.29.0/kind-linux-amd64

          # For ARM64
          [ $(uname -m) = aarch64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.29.0/kind-linux-arm64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

  kind:
    runs-on: ubuntu-latest
    needs:
      - prereqs
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - id: kind
        uses: helm/kind-action@v1
        # with:
        #   registry: true
        #   registry_name: custom-registry
        #   registry_port: 5001
        #   kubectl_version: "v1.32.0"
        #   ignore_failed_clean: true


      - name: Testing
        env:
            LOCAL_REGISTRY: ${{ steps.kind.outputs.LOCAL_REGISTRY }}

        run: |
            set +e
            sleep 30
            kubectl cluster-info
            kubectl version
            kubectl get pods -n kube-system

            docker pull busybox
            docker tag busybox registry:5000/verybusy
            docker push registry:5000/verybusy

            # kubectl run busy --image registry:5000/verybusy
            # sleep 30
            # kubectl describe pod busy
            
            kubectl create job test --image busybox
            kubectl wait --for=condition=complete --timeout=30s job/test
