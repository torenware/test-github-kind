name: "Create cluster using KinD"
on: [pull_request, push]

jobs:
  prereqs:
    runs-on: ubuntu-latest
    steps:
      - name: grab kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.32.0'
  kind:
    runs-on: ubuntu-latest
    needs:
      - prereqs
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: kind
        uses: helm/kind-action@v1
        # with:
        #   registry: true
        #   registry_name: custom-registry
        #   registry_port: 5001
        #   kubectl_version: "v1.32.0"
        #   ignore_failed_clean: true


      - name: Testing
        env:
            LOCAL_REGISTRY: ${{ steps.kind.outputs.LOCAL_REGISTRY }}

        run: |
            set +e
            sleep 30
            kubectl cluster-info
            kubectl version
            kubectl get pods -n kube-system

            docker pull busybox
            kubectl create job test --image busybox
            kubectl wait --for=condition=complete --timeout=30s job/test
