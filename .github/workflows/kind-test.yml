name: "Create cluster using KinD"
on: [pull_request, push]

jobs:
  kind:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: helm/kind-action@v1
        with:
          registry: true
          registry_name: custom-registry
          registry_port: 5001
          kubectl_version: "v1.32.0"
          ignore_failed_clean: true


      - name: Testing
        env:
            LOCAL_REGISTRY: ${{ steps.kind.outputs.LOCAL_REGISTRY }}

        run: |
            kubectl cluster-info
            kubectl version
            kubectl get pods -n kube-system

            if [[ -z "$(docker ps --filter "name=custom-registry" --format '{{.ID}}')" ]]; then
                echo "Registry is not present"
                exit 1
            fi

            docker pull busybox
            docker tag busybox "${{ env.LOCAL_REGISTRY}}/localbusybox"
            docker push "${{ env.LOCAL_REGISTRY}}/localbusybox"

            kubectl create job test "${{ env.LOCAL_REGISTRY}}/localbusybox"
            kubectl wait --for=condition=complete --timeout=30s job/test
